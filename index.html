<body>

Hello World
<button onclick="connect()" id="btn">Press dis.</button>
<form>
    <input id="textBox" type="text" placeholder="Skriv noe spennende...">
    <button type="submit" onclick="sendStuff()" id="btn">Send til micro:bit</button>
</form>

<div id="resultBox">



</div>


</body>

<script>
//Scanning for device with micro:bit - service

var writeCharacteristic; 
var resultBox = document.getElementById('resultBox');

function connect() {
    navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
    
    })
        .then(function(device) {
            resultBox.innerHTML += '<br>Connecting...'
            return device.gatt.connect();
        })

        .then(function(server) {
            resultBox.innerHTML += '<br>Server...'
            return server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e')
        })

        .then(function(service){
            resultBox.innerHTML += '<br>Service...'
            return service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e')
        })
        .then(function(characteristic){
            writeCharacteristic = characteristic; 
            var text = 'OK';
            var data = str2ab(text+':');
            var dataStr = ab2str(data);

            resultBox.innerHTML += '<br>Writing: ' + text;

            return characteristic.writeValue(data);
        })
        .catch(function(error) {
            console.error('Connection failed!', error);
            resultBox.innerHTML += ('<br>' + alert(error));
        });
}

function sendStuff() {
        var input = document.getElementById('textBox').value;
        var data = str2ab(input+':');
        var dataStr = ab2str(data);

        resultBox.innerHTML += '<br>Writing: ' + input;
        resultBox.innerHTML += '<br>Writing: ' + dataStr;
        return writeCharacteristic.writeValue(data);
}

function ab2str(buf) {
  return String.fromCharCode.apply(null, new Uint16Array(buf));
}

function str2ab(str) {
  var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
  var bufView = new Uint16Array(buf);
  for (var i=0, strLen=str.length; i<strLen; i++) {
    var charCode = str.charCodeAt(i);
    bufView[i] = (+charCode).toString(16)
  }

  resultBox.innerHTML += '<br>Writing: ';
            for(var i = 0; i < bufView.length; i++) {
                resultBox.innerHTML += bufView[i];
            }
            resultBox.innerHTML += '<br>';

  return buf;
}

</script>
